let correctAudio,incorrectAudio,correctAllAudio,stupidAudio;loadAudios();const AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext,kanjivgDir="/kanjivg";let prevCanvasSize,canvasSize=140,maxWidth=2;window.innerWidth>=768&&(canvasSize=280,maxWidth=4);let level=2;loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark"),localStorage.getItem("hint")==1&&(document.getElementById("hint").textContent="EASY"),localStorage.getItem("touch-50on-level")&&(level=parseInt(localStorage.getItem("touch-50on-level")))}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function toggleHint(a){localStorage.getItem("hint")==1?(localStorage.setItem("hint",0),a.textContent="HARD"):(localStorage.setItem("hint",1),a.textContent="EASY"),toggleAllStroke()}function toggleScroll(){const a=document.getElementById("scrollable"),b=document.getElementById("pinned");a.classList.contains("d-none")?(window.removeEventListener("touchstart",scrollEvent,{passive:!1}),window.removeEventListener("touchmove",scrollEvent,{passive:!1}),a.classList.remove("d-none"),b.classList.add("d-none")):(window.addEventListener("touchstart",scrollEvent,{passive:!1}),window.addEventListener("touchmove",scrollEvent,{passive:!1}),a.classList.add("d-none"),b.classList.remove("d-none"))}function playAudio(c,b){const a=audioContext.createBufferSource();if(a.buffer=c,b){const c=audioContext.createGain();c.gain.value=b,c.connect(audioContext.destination),a.connect(c),a.start()}else a.connect(audioContext.destination),a.start()}function unlockAudio(){audioContext.resume()}function loadAudio(a){return fetch(a).then(a=>a.arrayBuffer()).then(a=>new Promise((b,c)=>{audioContext.decodeAudioData(a,a=>{b(a)},a=>{c(a)})}))}function loadAudios(){promises=[loadAudio("/touch-50on/mp3/correct3.mp3"),loadAudio("/touch-50on/mp3/incorrect1.mp3"),loadAudio("/touch-50on/mp3/correct1.mp3"),loadAudio("/touch-50on/mp3/stupid5.mp3")],Promise.all(promises).then(a=>{correctAudio=a[0],incorrectAudio=a[1],correctAllAudio=a[2],stupidAudio=a[3]})}function prevTehon(){const b=this.parentNode.parentNode.querySelector(".tehon"),d=b.contentDocument,e=b.dataset.id;let a=1;b.dataset.animation&&(a=parseInt(b.dataset.animation)-1,a<1&&(a=1));let c=1;while(!0){const b=d.getElementById("kvg:"+e+"-s"+c);if(b)c<a?b.setAttribute("stroke","black"):c==a?b.setAttribute("stroke","red"):b.setAttribute("stroke","none");else break;c+=1}b.dataset.animation=a}function nextTehon(){const a=this.parentNode.parentNode.querySelector(".tehon"),e=a.contentDocument,d=a.dataset.id;let b=0;a.dataset.animation&&(b=parseInt(a.dataset.animation));const f=getKakusu(a,d);b<f&&(b+=1);let c=1;while(!0){const a=e.getElementById("kvg:"+d+"-s"+c);if(a)c<b?a.setAttribute("stroke","black"):c==b?a.setAttribute("stroke","red"):a.setAttribute("stroke","none");else break;c+=1}a.dataset.animation=b}customElements.define("problem-box",class extends HTMLElement{constructor(){super();const a=document.getElementById("problem-box").content.cloneNode(!0);this.attachShadow({mode:"open"}).appendChild(a)}}),customElements.define("tehon-box",class extends HTMLElement{constructor(){super();const a=document.getElementById("tehon-box").content.cloneNode(!0);if(window.innerWidth>=768){const b=a.querySelectorAll("canvas");[...b].forEach(a=>{a.setAttribute("width",canvasSize),a.setAttribute("height",canvasSize)})}a.querySelector(".prevTehon").onclick=prevTehon,a.querySelector(".nextTehon").onclick=nextTehon,this.attachShadow({mode:"open"}).appendChild(a)}}),customElements.define("tegaki-box",class extends HTMLElement{constructor(){super();const a=document.getElementById("tegaki-box").content.cloneNode(!0);if(window.innerWidth>=768){const b=a.querySelectorAll("canvas");[...b].forEach(a=>{a.setAttribute("width",canvasSize),a.setAttribute("height",canvasSize)})}this.attachShadow({mode:"open"}).appendChild(a)}});function getKakusu(b,c){let a=1;while(!0){const d=b.contentDocument.getElementById("kvg:"+c+"-s"+a);if(d)a+=1;else break}return a-1}function getTehonCanvas(b,a,c,d){return new Promise(function(g){const e=b.contentDocument.cloneNode(!0),h="kvg:StrokePaths_"+a,i=e.querySelector('[id="'+h+'"]');i.style.stroke="black";for(let b=1;b<=c;b++){const f=e.getElementById("kvg:"+a+"-s"+b);d!=b&&f.remove()}const j=e.documentElement.outerHTML,k=new Blob([j],{type:"image/svg+xml"}),l=URL.createObjectURL(k),f=new Image;f.src=l,f.onload=function(){const a=document.createElement("canvas");a.width=canvasSize,a.height=canvasSize;const b=a.getContext("2d");b.drawImage(f,0,0,canvasSize,canvasSize),g(a)}})}function toKanjiId(a){const b=a.codePointAt(0).toString(16);return("00000"+b).slice(-5)}function loadSVG(c,e,f,d){let b;d?b=document.createElement("tegaki-box"):b=document.createElement("tehon-box");const a=b.shadowRoot.querySelector("object");return a.setAttribute("data",kanjivgDir+"/"+c+".svg"),a.setAttribute("data-id",c),a.setAttribute("data-pos",f),d&&a.setAttribute("onload","_initSVG(this)"),e.appendChild(b),a}function showKanjiScore(a,c,d,e,g,b,f){if(a=Math.floor(a),a>=80?playAudio(correctAudio):playAudio(incorrectAudio),d.classList.remove("d-none"),d.textContent=a,mode!="conv"&&mode!="hirakana"&&mode!="kanahira"){for(let a=0;a<f;a++)changePathColor(a+1,e,b,"black");for(let a=0;a<f;a++)(!c[a][0]||c[a][0]<80)&&changePathColor(a+1,e,b,"red")}localStorage.getItem("hint")!=1&&changeAllColor(g,b,"lightgray")}function getKanjiScores(a,b,c,d,e,f){return Promise.all(a).then(g=>{let a=0,h=0;return g.forEach(c=>{const[d,b]=c;a+=d*b,h+=b}),a/=h,showKanjiScore(a,g,b,c,d,e,f),a})}function getProblemScores(b,c,d,e){const a=[];return d.forEach((d,g)=>{const f=d.dataset.id,h=getKakusu(d,f),i=parseInt(d.dataset.pos);let j=0;const k=e[g].toData();if(k.length!=0){const a=c.children[i].shadowRoot.querySelector("object"),e=b.children[i].shadowRoot.querySelector(".score"),g=getKakuScores(k,d,f,h);j=getKanjiScores(g,e,a,d,f,h)}a[g]=j}),Promise.all(a)}function setScoringButton(a,b,c,d,e,f){const g=a.shadowRoot.querySelector(".scoring");g.addEventListener("click",function(){getProblemScores(b,c,d,e).then(c=>{if(c.every(a=>a>=80)){a.shadowRoot.querySelector(".guard").style.height="100%";const b=a.nextElementSibling;if(b){b.shadowRoot.querySelector(".guard").style.height="0";const a=document.getElementById("header").offsetHeight,c=b.getBoundingClientRect().top+document.documentElement.scrollTop-a;window.scrollTo({top:c,behavior:"smooth"})}else window.removeEventListener("touchstart",scrollEvent,{passive:!1}),window.removeEventListener("touchmove",scrollEvent,{passive:!1})}let b=localStorage.getItem("touch-50on");b||(b=""),c.forEach((a,c)=>{a<40&&(b=b.replace(f[c],""))}),localStorage.setItem("touch-50on",b)})})}function setSignaturePad(a){const b=a.parentNode.querySelector(".tegaki"),c=new SignaturePad(b,{minWidth:maxWidth,maxWidth,penColor:"black",throttle:0,minDistance:0});return c}function setEraser(b,c,d,a,e){const f=a.getRootNode().host,g=[...c.children].findIndex(a=>a==f);d.children[g].shadowRoot.querySelector(".eraser").onclick=function(){const d=b.toData();d&&b.clear();const f=parseInt(a.dataset.pos),g=c.children[f].shadowRoot.querySelector(".score");g.classList.add("d-none"),localStorage.getItem("hint")!=1&&changeAllColor(a,e,"none")}}function setSound(a,b,c){const d=parseInt(b.dataset.pos),e=a.children[d].shadowRoot.querySelector(".sound"),f=kanaToHira(c);e.onclick=function(){new Audio("/touch-50on/voice/波音リツ/"+f+".mp3").play()}}function loadProblem(a,h){const d=document.createElement("problem-box"),f=d.shadowRoot,g=[],e=[],b=f.querySelector(".tehon"),c=f.querySelector(".tegaki");for(let d=0;d<a.length;d++){const i=toKanjiId(a[d]);loadSVG(i,b,d,!1);const f=loadSVG(toKanjiId(h[d]),c,d,!0),j=setSignaturePad(f);g.push(f),e.push(j),setEraser(j,c,b,f,i),setSound(b,f,a[d])}return setScoringButton(d,c,b,g,e,a),document.getElementById("problems").appendChild(d),e}function resizeTegakiContents(a){a.forEach(b=>{const c=b._canvas;resizeCanvasSize(c,canvasSize);const a=b.toData();if(a.length>0){if(b.maxWidth=maxWidth,b.minWidth=maxWidth,prevCanvasSize<canvasSize)for(let b=0;b<a.length;b++)for(let c=0;c<a[b].length;c++)a[b][c].x*=2,a[b][c].y*=2;else for(let b=0;b<a.length;b++)for(let c=0;c<a[b].length;c++)a[b][c].x/=2,a[b][c].y/=2;b.fromData(a)}})}function resizeCanvasSize(a,b){a.setAttribute("width",b),a.setAttribute("height",b)}function resizeTehonContents(){const a=document.getElementById("problems").children;for(const b of a){const c=b.shadowRoot.querySelector(".tegaki").children,d=b.shadowRoot.querySelector(".tehon").children;[...c].forEach(a=>{const b=a.shadowRoot.querySelector(".tehon");resizeCanvasSize(b,canvasSize)}),[...d].forEach(a=>{const b=a.shadowRoot.querySelector(".tehon");resizeCanvasSize(b,canvasSize)})}}function loadDrill(b,c){let a=[];for(let d=0;d<b.length;d++){const e=loadProblem(b[d],c[d]);a=a.concat(e)}window.onresize=function(){prevCanvasSize=canvasSize,window.innerWidth>=768?(canvasSize=280,maxWidth=4):(canvasSize=140,maxWidth=2),prevCanvasSize!=canvasSize&&(resizeTegakiContents(a),resizeTehonContents())}}function setStrokeWidth(a){return 15+6/a}function toggleAllStroke(){const a=document.getElementById("problems").children;for(const b of a){const c=b.shadowRoot.querySelector(".tegaki").children;for(const d of c){const a=d.shadowRoot.querySelector("object"),b=a.dataset.id,e=getKakusu(a,b);toggleStroke(a,b,e)}}}function toggleStroke(b,c,d){const e="kvg:StrokePaths_"+c,a=b.contentDocument.querySelector('[id="'+e+'"]');localStorage.getItem("hint")!=1?a.style.stroke="none":a.style.stroke="lightgray",a.style.strokeWidth=setStrokeWidth(d)}function changeAllColor(a,b,c){const d="kvg:StrokePaths_"+b,e=a.contentDocument.querySelector('[id="'+d+'"]');e.style.stroke=c}function changePathColor(a,b,c,d){const e=b.contentDocument.getElementById("kvg:"+c+"-s"+a);e.setAttribute("stroke",d)}function removeNumbers(a,b){const c="kvg:StrokeNumbers_"+b,d=a.contentDocument.querySelector('[id="'+c+'"]');d.remove()}function countNoTransparent(a){let b=0;for(let c=3;c<a.length;c+=4)a[c]!=0&&(b+=1);return b}function getInclusionCount(a,b){for(let c=3;c<a.length;c+=4)b[c]!=0&&(a[c]=0);const c=countNoTransparent(a);return c}function getScoringFactor(a){switch(a){case 0:return.5**2;case 1:return.6**2;case 2:return.7**2;case 3:return.8**2;case 4:return.9**2;default:return.7**2}}function calcKakuScore(b,e,f){let c=1-Math.abs((e-b)/e);c>1&&(c=1);let d=(b-f)/b;d>1&&(d=1);let a=c*d*100/getScoringFactor(level);return a<0&&(a=0),a>100&&(a=100),isNaN(a)&&(a=0),a}function getKakuScores(c,d,e,a){let b=setStrokeWidth(a)*109/canvasSize;canvasSize>140&&(b*=4);const f=new Array(a);for(let g=0;g<a;g++)f[g]=new Promise(f=>{if(c[g]){c[g].minWidth=b,c[g].maxWidth=b;const h=document.createElement("canvas");h.setAttribute("width",canvasSize),h.setAttribute("height",canvasSize);const j=h.getContext("2d"),k=new SignaturePad(h,{minWidth:b,maxWidth:b,penColor:"black"});k.fromData([c[g]]);const i=j.getImageData(0,0,canvasSize,canvasSize).data,l=countNoTransparent(i);getTehonCanvas(d,e,a,g+1).then(c=>{const a=c.getContext("2d").getImageData(0,0,canvasSize,canvasSize).data,b=countNoTransparent(a),d=getInclusionCount(i,a),e=calcKakuScore(l,b,d);f([e,b])})}else getTehonCanvas(d,e,a,g+1).then(a=>{const b=a.getContext("2d").getImageData(0,0,canvasSize,canvasSize).data,c=countNoTransparent(b);f([0,c])})});return f}function _initSVG(a){const b=a.dataset.id,c=getKakusu(a,b);toggleStroke(a,b,c),removeNumbers(a,b)}function report(){const a=[],c=document.getElementById("problems").children;for(let b=0;b<c.length;b++){const d=c[b].shadowRoot.querySelector(".tegaki").children;for(let b=0;b<d.length;b++){const c=d[b].shadowRoot.querySelector(".score").textContent;a.push(parseInt(c))}}let b=0;for(let c=0;c<a.length;c++)b+=a[c];if(b/=a.length,b>=80){playAudio(correctAllAudio);let a=localStorage.getItem("touch-50on");a?(kanjis.split("").forEach(b=>{a.includes(b)||(a+=b)}),localStorage.setItem("touch-50on",a)):localStorage.setItem("touch-50on",kanjis),document.getElementById("report").classList.add("d-none"),document.getElementById("correctReport").classList.remove("d-none"),setTimeout(()=>{location.href="/touch-50on/"},3e3)}else playAudio(stupidAudio),document.getElementById("report").classList.add("d-none"),document.getElementById("incorrectReport").classList.remove("d-none"),setTimeout(function(){document.getElementById("report").classList.remove("d-none"),document.getElementById("incorrectReport").classList.add("d-none")},6e3)}function kanaToHira(a){return a.replace(/[\u30a1-\u30f6]/g,function(a){const b=a.charCodeAt(0)-96;return String.fromCharCode(b)})}function convHirakana(a){for(let b=0;b<a.length;b++)if(a[b].test(/[\u3041-\u3096]/)){const c=a[b].charCodeAt(0)+96;a[b]=String.fromCharCode(c)}else if(a[b].test(/[\u30a1-\u30f6]/)){const c=a[b].charCodeAt(0)-96;a[b]=String.fromCharCode(c)}return a}let kanjis="",mode="hirahira";function initQuery(){let a,b;const c=new URLSearchParams(location.search);mode=c.get("mode"),kanjis=c.get("q");const d=c.get("problem");if(kanjis)if(mode=="conv"){const c=convHirakana(kanjis);a=kanjis.split(""),b=c.split("")}else a=kanjis.split(""),b=kanjis.split("");else if(d=="50on"){const c=Array.from("あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよわん"),d=Array.from("アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨワン");mode=="hirahira"?(a=c,b=c):mode=="hirakana"?(a=c,b=d):mode=="kanakana"?(a=d,b=d):(a=d,b=c)}else{const c=Array.from("がぎぐげござじずぜぞだぢづでどばびぶべぼぱぴぷぺぽ"),d=Array.from("ガギグゲゴザジズゼゾダヂヅデドバビブベボパピプペポ");mode=="hirahira"?(a=c,b=c):mode=="hirakana"?(a=c,b=d):mode=="kanakana"?(a=d,b=d):(a=d,b=c)}loadDrill(a,b),document.getElementById("problems").children[0].shadowRoot.querySelector(".guard").style.height="0"}function scrollEvent(a){["MAIN","PROBLEM-BOX","A","BUTTON","path"].includes(a.target.tagName)||a.preventDefault()}initQuery(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("hint").onclick=toggleHint,document.getElementById("toggleScroll").onclick=toggleScroll,document.getElementById("reportButton").onclick=report,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0}),document.ondblclick=a=>{a.preventDefault()}